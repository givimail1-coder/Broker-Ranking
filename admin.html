<script>
    // Function to format numbers with commas
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // Function to calculate progress percentage
    function calculateProgress(commission, target) {
        return Math.min(100, Math.round((commission / target) * 100));
    }

    // Function to update the current date
    function updateDate() {
        const options = { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Asia/Dubai' };
        const now = new Date();
        const formatter = new Intl.DateTimeFormat('en-US', options);
        document.getElementById('current-date').textContent = formatter.format(now);
    }

    // Function to load logo and data from JSON file
    async function loadData() {
        try {
            const response = await fetch('broker-data.json');
            const data = await response.json();
            
            // Update logo
            if (data.logo) {
                document.getElementById('company-logo').src = data.logo;
            }
            
            // Return broker data
            return data.brokers || [];
        } catch (error) {
            console.error('Error loading data:', error);
            // Return sample data if file doesn't exist yet
            return [
                {
                    rank: 1,
                    photo: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1887&q=80",
                    name: "Ahmed Al Mansouri",
                    commission: 1500000,
                    target: 2000000,
                    listings: 15
                },
                {
                    rank: 2,
                    photo: "https://images.unsplash.com/photo-1552058544-f2b08422138a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1899&q=80",
                    name: "Fatima Al Zahra",
                    commission: 950000,
                    target: 1500000,
                    listings: 12
                },
                {
                    rank: 3,
                    photo: "https://images.unsplash.com/photo-1554151228-14d9def656e4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1886&q=80",
                    name: "Mohammed Hassan",
                    commission: 2200000,
                    target: 2500000,
                    listings: 18
                },
                {
                    rank: 4,
                    photo: "https://images.unsplash.com/photo-1567532939604-b6b5b0db1604?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1887&q=80",
                    name: "Layla Abbas",
                    commission: 800000,
                    target: 1500000,
                    listings: 9
                },
                {
                    rank: 5,
                    photo: "https://images.unsplash.com/photo-1570295999919-56ceb5ecca61?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1780&q=80",
                    name: "Omar Khalid",
                    commission: 1800000,
                    target: 2500000,
                    listings: 17
                }
            ];
        }
    }

    // Function to populate the brokers table
    async function populateBrokersTable() {
        const brokerData = await loadData();
        const tableBody = document.getElementById('brokers-table-body');
        tableBody.innerHTML = '';

        brokerData.forEach(broker => {
            const progress = calculateProgress(broker.commission, broker.target);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="rank">${broker.rank}</td>
                <td class="photo"><img src="${broker.photo}" alt="${broker.name}" class="broker-photo"></td>
                <td class="name">${broker.name}</td>
                <td class="commission number">${formatNumber(broker.commission)}</td>
                <td class="progress-cell">
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${progress}%">${progress}%</div>
                    </div>
                </td>
                <td class="target number">${formatNumber(broker.target)}</td>
                <td class="listings number">${formatNumber(broker.listings)}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Initialize the dashboard
    function initDashboard() {
        updateDate();
        populateBrokersTable();
        
        // Update date every minute
        setInterval(updateDate, 60000);
        
        // Update data every 30 seconds
        setInterval(populateBrokersTable, 30000);
    }

    // Run initialization when page loads
    document.addEventListener('DOMContentLoaded', initDashboard);
</script>
